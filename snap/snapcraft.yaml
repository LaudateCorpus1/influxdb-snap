name: influxdb
version: '1.5.1'
summary: An Open-Source Time Series Database
description: |
  InfluxDB is an open source time series database with no external dependencies.
  It's useful for recording metrics, events, and performing analytics.

grade: devel
confinement: strict

parts:
  scripts:
    source: scripts
    plugin: dump
    organize:
      '*.sh': bin/
    prime:
      - bin
  go:
    source-tag: go1.9.5
    source-depth: 1
  influxdb:
    after: [go]
    source: https://github.com/influxdata/influxdb.git
    source-tag: v1.5.1
    plugin: python
    install: |
      mv build/influx $SNAPCRAFT_PART_INSTALL/bin/influx
      mv build/influx_inspect $SNAPCRAFT_PART_INSTALL/bin/influx_inspect
      mv build/influx_stress $SNAPCRAFT_PART_INSTALL/bin/influx_stress
      mv build/influx_tsm $SNAPCRAFT_PART_INSTALL/bin/influx_tsm
      mv build/influxd $SNAPCRAFT_PART_INSTALL/bin/influxd
    build: |
      env | grep SNAPCRAFT
      export PATH="$SNAPCRAFT_STAGE/bin:$PATH"
      export GOPATH=$(readlink -f $(pwd)/../go)
      export GOIMPORTPATH=$GOPATH/src/github.com/influxdata/influxdb/
      mkdir -p $GOIMPORTPATH
      cp -r . $GOIMPORTPATH
      cd $GOIMPORTPATH
      python build.py
    stage-packages:
      - libdb5.3-dev
    build-packages: 
      - python-software-properties
      - software-properties-common
      - wget
      - git
      - mercurial
      - make
      - ruby
      - ruby-dev
      - autoconf
      - libtool
      - build-essential
      - rpm
      - zip
      - python
      - python-boto
      - asciidoc
      - xmlto
      - docbook-xsl


apps:
  influx:
    command: bin/influx
    plugs:
      - network
  influxd:
    command: bin/runinfluxd.sh
    daemon: simple
    restart-condition: always
    plugs:
      - network-bind
      - network